name: Rick and Morty Pipeline
on:
  push:
    branches: [ main ]

jobs:
  kubernetes-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # 1. Initiate small kubernetes cluster (Kind)
      - name: Create KinD Cluster
        uses: helm/kind-action@v1.4.0

      # 2. Create the Docker image from Dockerfile
      - name: Build local Docker image
        run: |
          docker build -t omergldb/rick-morty-script:v6 .
          # Load the image into the Kind nodes so it's available for deployment
          kind load docker-image omergldb/rick-morty-script:v6 --name chart-testing

      # 3. Deploy the application to the local cluster
      - name: Deploy Helm Chart
        run: |
          helm install rick-release ./rick-morty-chart \
            --set image.repository=omergldb/rick-morty-script \
            --set image.tag=v6

      # 4. Run tests and Verify Output
      - name: Verify Results
        run: |
          echo "Waiting for Pod to be ready..."
          sleep 20
          
          POD_NAME=$(kubectl get pods --no-headers -o custom-columns=":metadata.name" | grep "rick-release" | head -n 1)
          echo "Testing Pod: $POD_NAME"

          kubectl wait --for=condition=Ready "pod/$POD_NAME" --timeout=90s
          
          echo "--- START OF POD LOGS ---"
          kubectl logs "$POD_NAME"
          echo "--- END OF POD LOGS ---"

          # Check for the file
          if kubectl exec "$POD_NAME" -- ls /app/data/results.csv; then
            echo "SUCCESS: File exists in volume."
          else
            echo "ERROR: File /app/data/results.csv not found!"
            exit 1
          fi

          # FIXED: Run the command INSIDE the pod to count lines
          DATA_COUNT=$(kubectl exec "$POD_NAME" -- sh -c "wc -l < /app/data/results.csv")
          echo "Found $DATA_COUNT lines in CSV."
          
          # Final Step: Ensure there is actually data (more than 1 line for header)
          if [ "$DATA_COUNT" -gt 1 ]; then
            echo "Pipeline Verified: Data successfully written."
          else
            echo "Error: CSV is empty."
            exit 1
          fi