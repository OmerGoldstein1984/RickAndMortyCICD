name: Rick and Morty CI/CD
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# Grouping common variables at the top
env:
  DOCKER_IMAGE: omergldb/rick-morty-script
  IMAGE_TAG: v6
  RELEASE_NAME: rick-release
  KIND_CLUSTER_NAME: chart-testing

jobs:
  validate-and-deploy:
    name: Build, Deploy & Test
    runs-on: ubuntu-latest
    steps:
      - name: üöÄ Checkout Repository
        uses: actions/checkout@v4

      - name: üèóÔ∏è Setup KinD Cluster
        uses: helm/kind-action@v1.8.0
        with:
          cluster_name: ${{ env.KIND_CLUSTER_NAME }}

      - name: üì¶ Build & Load Docker Image
        run: |
          docker build -t ${{ env.DOCKER_IMAGE }}:${{ env.IMAGE_TAG }} .
          kind load docker-image ${{ env.DOCKER_IMAGE }}:${{ env.IMAGE_TAG }} --name ${{ env.KIND_CLUSTER_NAME }}

      - name: ‚ò∏Ô∏è Deploy Application via Helm
        run: |
          helm install ${{ env.RELEASE_NAME }} ./rick-morty-chart \
            --set image.repository=${{ env.DOCKER_IMAGE }} \
            --set image.tag=${{ env.IMAGE_TAG }} \
            --wait
      - name: üß™ Automated Verification Tests
        run: |
          echo "Syncing with Kubernetes..."
          sleep 20
          
          # 1. Broad Search: Find ANY pod that has 'rick' in the name
          # This avoids the 'no matching resources' error caused by incorrect labels
          POD_NAME=$(kubectl get pods --no-headers -o custom-columns=":metadata.name" | grep "rick" | head -n 1)
          
          if [ -z "$POD_NAME" ]; then
            echo "‚ùå ERROR: No pods found containing 'rick'. Current pods:"
            kubectl get pods
            exit 1
          fi

          echo "‚úÖ Found Pod: $POD_NAME"

          # 2. Wait for the specific Pod name found
          kubectl wait --for=condition=Ready "pod/$POD_NAME" --timeout=60s

          # 3. Verification Commands
          echo "--- Execution Logs ---"
          kubectl logs "$POD_NAME"
          
          echo "Checking for file in Volume..."
          kubectl exec "$POD_NAME" -- ls -l /app/data/results.csv