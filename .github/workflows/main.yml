name: Rick and Morty Pipeline
on:
  push:
    branches: [ main ]

jobs:
  kubernetes-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # 1. Initiate small kubernetes cluster (Kind)
      - name: Create KinD Cluster
        uses: helm/kind-action@v1.4.0

      # 2. Create the Docker image from Dockerfile
      - name: Build local Docker image
        run: |
          docker build -t omergldb/rick-morty-script:v6 .
          # Load the image into the Kind nodes so it's available for deployment
          kind load docker-image omergldb/rick-morty-script:v6 --name chart-testing

      # 3. Deploy the application to the local cluster
      - name: Deploy Helm Chart
        run: |
          helm install rick-release ./rick-morty-chart \
            --set image.repository=omergldb/rick-morty-script \
            --set image.tag=v6

      # 4. Run tests and Verify Output
      - name: Verify Results
        run: |
          echo "Waiting for Pod to be ready..."
          sleep 20
          # 1. Capture the pod name
          POD_NAME=$(kubectl get pods --no-headers -o custom-columns=":metadata.name" | grep "rick-release" | head -n 1)
          echo "Testing Pod: $POD_NAME"

          # 2. Wait for it
          kubectl wait --for=condition=Ready "pod/$POD_NAME" --timeout=90s
          
          # 3. Print logs regardless of success so we can debug
          echo "--- START OF POD LOGS ---"
          kubectl logs "$POD_NAME"
          echo "--- END OF POD LOGS ---"

          # 4. Check for the file (This is likely where it fails if the script crashed)
          if kubectl exec "$POD_NAME" -- ls /app/data/results.csv; then
            echo "SUCCESS: File exists in volume."
          else
            echo "ERROR: File /app/data/results.csv not found!"
            exit 1
          fi

          # 5. Final check for data content
          DATA_COUNT=$(kubectl exec "$POD_NAME" -- wc -l < /app/data/results.csv)
          echo "Found $DATA_COUNT lines in CSV."