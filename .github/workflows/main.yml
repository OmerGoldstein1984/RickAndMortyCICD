name: Rick and Morty CI/CD
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# Grouping common variables at the top
env:
  DOCKER_IMAGE: omergldb/rick-morty-script
  IMAGE_TAG: v6
  RELEASE_NAME: rick-release
  KIND_CLUSTER_NAME: chart-testing

jobs:
  validate-and-deploy:
    name: Build, Deploy & Test
    runs-on: ubuntu-latest
    steps:
      - name: üöÄ Checkout Repository
        uses: actions/checkout@v4

      - name: üèóÔ∏è Setup KinD Cluster
        uses: helm/kind-action@v1.8.0
        with:
          cluster_name: ${{ env.KIND_CLUSTER_NAME }}

      - name: üì¶ Build & Load Docker Image
        run: |
          docker build -t ${{ env.DOCKER_IMAGE }}:${{ env.IMAGE_TAG }} .
          kind load docker-image ${{ env.DOCKER_IMAGE }}:${{ env.IMAGE_TAG }} --name ${{ env.KIND_CLUSTER_NAME }}

      - name: ‚ò∏Ô∏è Deploy Application via Helm
        run: |
          helm install ${{ env.RELEASE_NAME }} ./rick-morty-chart \
            --set image.repository=${{ env.DOCKER_IMAGE }} \
            --set image.tag=${{ env.IMAGE_TAG }} \
            --wait

      - name: üß™ Automated Verification Tests
        run: |
          echo "Syncing with Kubernetes..."
          sleep 10
          
          # Reliable Pod Discovery
          POD_NAME=$(kubectl get pods -l app.kubernetes.io/instance=${{ env.RELEASE_NAME }} -o name)
          
          echo "Targeting Pod: $POD_NAME"
          kubectl wait --for=condition=Ready "$POD_NAME" --timeout=60s

          echo "--- Execution Logs ---"
          kubectl logs "$POD_NAME"
          
          # Test Suite
          echo "Running Data Validation..."
          
          # 1. Log Success Check
          kubectl logs "$POD_NAME" | grep -q "SUCCESS" || (echo "Fail: No success message"; exit 1)
          
          # 2. File Integrity Check
          kubectl exec "$POD_NAME" -- ls /app/data/results.csv || (echo "Fail: CSV not found"; exit 1)
          
          # 3. Data Content Check (Ensure more than just the header)
          LINE_COUNT=$(kubectl exec "$POD_NAME" -- sh -c "wc -l < /app/data/results.csv")
          echo "Verified: $LINE_COUNT rows found in results."
          
          if [ "$LINE_COUNT" -le 1 ]; then
            echo "Fail: CSV contains no data"
            exit 1
          fi
          
          echo "‚úÖ All tests passed successfully!"