name: Rick and Morty Pipeline
on:
  push:
    branches: [ main ]

jobs:
  kubernetes-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # 1. Initiate small kubernetes cluster (Kind)
      - name: Create KinD Cluster
        uses: helm/kind-action@v1.4.0

      # 2. Create the Docker image from Dockerfile
      - name: Build local Docker image
        run: |
          docker build -t omergldb/rick-morty-script:v6 .
          # Load the image into the Kind nodes so it's available for deployment
          kind load docker-image omergldb/rick-morty-script:v6 --name chart-testing

      # 3. Deploy the application to the local cluster
      - name: Deploy Helm Chart
        run: |
          helm install rick-release ./rick-morty-chart \
            --set image.repository=omergldb/rick-morty-script \
            --set image.tag=v6

      # 4. Run tests and Verify Output
      - name: Verify Results
        run: |
          echo "Waiting 20 seconds for Pod to initialize..."
          sleep 20
          
          # 1. Get the pod name using a name filter instead of a label selector
          # This finds any pod with 'rick-release' in its name
          POD_NAME=$(kubectl get pods --no-headers -o custom-columns=":metadata.name" | grep "rick-release" | head -n 1)
          
          if [ -z "$POD_NAME" ]; then
            echo "ERROR: Could not find a pod with 'rick-release' in the name."
            kubectl get pods
            exit 1
          fi
          
          echo "Successfully found pod: $POD_NAME"

          # 2. Wait for this specific pod name to be Ready
          kubectl wait --for=condition=Ready "pod/$POD_NAME" --timeout=90s
          
          # 3. TEST: Check logs for the SUCCESS message
          kubectl logs "$POD_NAME" | grep "SUCCESS"
          
          # 4. TEST: Verify the file exists in the volume mount
          kubectl exec "$POD_NAME" -- ls -l /app/data/results.csv
          
          # 5. TEST: Show the first 5 lines of the CSV
          kubectl exec "$POD_NAME" -- head -n 5 /app/data/results.csv